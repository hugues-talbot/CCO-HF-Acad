%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Thin Sectioned Essay
% LaTeX Template
% Version 1.0 (3/8/13)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original Author:
% Nicolas Diaz (nsdiaz@uc.cl) with extensive modifications by:
% Vel (vel@latextemplates.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[a4paper, 11pt]{article} % Font size (can be 10pt, 11pt or 12pt) and paper size (remove a4paper for US letter paper)
\usepackage[inner=2cm,outer=2cm]{geometry} %left=4cm,right=2cm would be equivalent

\usepackage[protrusion=true,expansion=true]{microtype} % Better typography
\usepackage{graphicx} % Required for including pictures
\usepackage{wrapfig} % Allows in-line images
\usepackage{subfigure}
\usepackage{amsmath}
\usepackage{mathpazo} % Use the Palatino font
\usepackage[T1]{fontenc} % Required for accented characters
\usepackage[toc,page]{appendix}
\newcommand{\sqlen}[1]{\ensuremath{(x - x_{#1})^2 + (y-y_{#1})^2}}
\newcommand{\rili}[1]{\ensuremath{\frac{r_{#1}^2}{l_{#1}}}}
\usepackage[mediumspace,mediumqspace,Grey,squaren]{SIunits}
\linespread{1.05} % Change line spacing here, Palatino benefits from a slight increase by default

\makeatletter
\renewcommand\@biblabel[1]{\textbf{#1.}} % Change the square brackets for each bibliography item from '[1]' to '1.'
\renewcommand{\@listI}{\itemsep=0pt} % Reduce the space between items in the itemize and enumerate environments and the bibliography

\renewcommand{\maketitle}{ % Customize the title - do not edit title and author name here, see the TITLE block below
\begin{flushright} % Right align
{\LARGE\@title} % Increase the font size of the title

\vspace{50pt} % Some vertical space between the title and author name

{\large\@author} % Author name
\\\@date % Date

\vspace{40pt} % Some vertical space between the author block and abstract
\end{flushright}
}

%----------------------------------------------------------------------------------------
%	TITLE
%----------------------------------------------------------------------------------------

\title{\textbf{Constrained Constructive Optimization implementation}\\ % Title
Reproducing Rudolph Karch paper} % Subtitle

\author{\textsc{Clara Jaquet} % Author
\\{\textit{Paris-Est University}}} % Institution

\date{\today} % Date

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle % Print the title section

%----------------------------------------------------------------------------------------
%	ABSTRACT AND KEYWORDS
%----------------------------------------------------------------------------------------

%\renewcommand{\abstractname}{Summary} % Uncomment to change the name of the abstract to something else

\begin{abstract}
Implement CCO in 2D, then 3D based on Karch's work \cite{karch1999three}. In another step consider implementation for convex volume. 
Combination of CFD laws, geometry, and optimization. Encapsulated articles : requires summary in one paper.
\end{abstract}

\hspace*{3,6mm}\textit{Keywords:} constrained constructive optimization, implementation % Keywords

\vspace{30pt} % Some vertical space between the abstract and first section

\tableofcontents
%----------------------------------------------------------------------------------------
%	ESSAY BODY
%----------------------------------------------------------------------------------------

\section*{Introduction}

Constrained Constructive Optimization (CCO) consists of growing a tree governed by minimizing a target function. 

In Karch's method the tree is constrained into a given convex perfusion volume, and the target function minimizes the total tree volume during growth. Segment are added one by one and fulfill both local optimization (single bifurcation scale) and global optimization (tree scale). The local optimization is based on Kamiya's work \cite{kamiya1972optimal}, whereas the global optimization has been implemented first by Schreiner in 2D \cite{schreiner1993computer}. 

\section{Global optimization}

Initialization of the method requires some physiological parameters as input, and a randomized starting point.

Then Karch's protocol consists of a complete loop for each added segment. A  random location is picked under some constraints (geometry and physiology), to use it as a candidate for segment extremity. Its connection is tested with neighbor segments, producing a bifurcation under topological, structural and functional constraints. In view of this new branch impact on the whole tree (induced by fluid mechanics laws), the optimal connection is selected by minimizing a target function (the minimal volume of the total tree). 


\subsection{Assumptions and boundary conditions}
The vascular tree is grown under specific assumptions and boundary conditions.

The perfused volume is convex and supposed homogeneously filled. The terminal segments correspond to pre-arteriole level, feeding a non modeled micro-vasculature.
The blood is an incompressible, homgeneous Newtonian fluid, studied in a steady state and in laminar flow conditions. 

The resistance and the pressure drop of a segment $j$ are defined by:
\begin{equation}\label{resistance}
R_j = \frac{8\mu}{\pi}\frac{l_j}{r_j^4} \text{ with } \mu \text{ the viscosity }
\end{equation}
\begin{equation}\label{Pdrop}
\Delta P_j = R_j Q_j
\end{equation}
The total resistance of the tree is calculated recursively by tree decomposition, considering parallel and serial arrangements.

The physiological parameters are defined such as in the following table:\\ % missing table
\begin{center}
\begin{tabular}{ccc}

\hline

Parameter & Meaning & Value\\
\hline
$V_{perf}$ & perfusion volume   & \unit{100}{\centi\cubic\meter}\\
$P_{perf}$ & perfusion pressure & \unit{100}{\milli\meter}Hg\\
$P_{term}$ & terminal pressure  & \unit{60}{\milli\meter}Hg\\
$Q_{perf}$ & perfusion flow     & \unit{500}{\milli\liter / \min}\\
$Q_{term}$ & terminal flow 	    & \unit{0.125}{\milli\liter / \min}\\
$N_{term}$   & number of terminals & 4000\\
$\mu$	   & viscosity of blood & \unit{3.6}{\centi}p\\
$\gamma$   & Murray bifurcation exponent & 3\\
\hline
\end{tabular}
\end{center}
\vspace{15pt}

The pressure at distal end of terminal segment,$P_{term}$, are equal and correspond to the inflow pressure to the micro-circulation.
The terminal flows $Q_{term,j}$ are equal, and delivered into the micro-circulation agains $P_{term}$. Because of flow conservation their sum correspond to the perfusion flow at the root $Q_{perf}$. 
The laminar flow resistance of the whole tree induces a given total $Q_{perf}$ accross $\Delta P$. The perfusion flow $Q_{perf}$ is the same for each step of the tree generation.

The tree grown is dichotomic. The produced tree is always a binary tree and the total number of segments is calculated from:
\begin{equation}
N_{tot} = 2 N_{term} -1
\end{equation}

This tree follows Murray's law, with a power coefficient equal to 3.

\subsection{Initialization step}  
Inputs:
\begin{itemize}
\item convex perfusion surface or volume definition: position and shape
\item number of terminal segments, $N_{term}$
\item location of the root (in our case on the border of the perfusion territory)
\item a random location inside the perfusion territory for the first segment end 
\end{itemize}

\subsection{Loop to add new segment}
We are provided a new location, $n_{loc}$, and want to find its optimal connection to the existing tree. For this purpose we select the $N_{con}$ closest existing segments to this location, compute a local optimization for each of them, then evaluate the connection impact on the whole tree, and as a global optimization process, we determine the one minimizing best the total tree volume.

\begin{figure}[!h]
\centering
\subfigure{\includegraphics[width=0.9\textwidth]{./Images/AddNewSegmentTestNeighbors.png}}
\caption{To add a new segment: test connection with neighbors of the new location $n_{loc}$ and select the one minimizing the total tree volume}
\label{fig:test neighbors}
\end{figure}

\subsubsection{Constrained new location $n_{loc}$}
A random position is picked, that has to fulfill two constraints: belonging to the perfusion territory and respecting a distance criterion. 
This criterion is defined based on the final and current size of the tree:
\begin{equation}
d_{thresh} = (\pi r_{supp}^2 / k_{term})^\frac{1}{2}
\end{equation}
with $k_{term}$ the number of terminal segment at the current step, and $r_{supp}$ defined from  the estimated size of a micro-circulatory black-box area, knowing the total perfused area $A_{perf}$:
\begin{equation}
\pi r_{supp}^2 = A_{perf} / N_{term}
\end{equation}
In 3D this criterion is defined as:
\begin{equation}
d_{thresh} = (\frac{4}{3} \pi r_{supp}^3 / k_{term})^\frac{1}{3}
\end{equation}
with
\begin{equation}
\frac{4}{3}\pi r_{supp}^3 = V_{perf} / N_{term}
\end{equation}
This distance criteron is updated after each new segment is added, so that it decreases during tree growth. If no location is found that respect this distance to existing segments within the perfusion territory, then the distance criterion is multiplied by 0.9 and the process repeated until a new position is found that fulfills both constraints. 

\subsubsection{Test local connection}

For each neighbor segment of $n_{loc}$ we calculate what would be the optimal connection to $n_{loc}$ based on a single bifurcation optimization procedure established by Kamyia \cite{kamiya1972optimal}, and is fully detailed in section \ref{Kamiya}. If this local optimization process is successful, we apply two additional checks:
\begin{itemize}
\item We control that the resulting segments are not degenerate, which means all three segments of the new bifurcations respect the following constraint between length and radius: $2r_i \leq l_i$

\item We control that none of the three resulting segments overlap any other existing tree segment.
\end{itemize}

With this step we ensure the connection to be locally optimal and plausible for the tree.

\subsubsection{Propagate impact on whole tree}
By adding a new terminal segments, inducing a new generated bifurcation, we perturb the distribution of segmental flows. In order to reestablish the correct terminal flows, the hydrodynamic resistance of the tree must be adjusted. As the lengths of the segments as well as the terminal and perfusion pressures are fixed, this can only be accomplished by proper rescaling of the segment's radii.\\

If we define the reduced hydrodynamic resistance $R^*$ as $R^*_i = R_i r_i^4$ we can calculate the reduced hydrodynamic resistance of a segment including its left and right subtrees by recursively traversing the subtrees:
\begin{equation} \label{red resistance}
R^*_{sub,j} = \frac{8\mu}{\pi}l_j + \left( \frac{(r_{left,j}/r_j)^4}{R_{left,j}^*} + \frac{(r_{right,j}/r_j)^4}{R_{right,j}^*}\right)^{-1}
\end{equation}
Considering the assumptions \ref{Pdrop} and \ref{resistance}, we can then calculate the radius ratio of two children segments from resistance and flow:
\begin{equation} \label{children ratio}
\frac{r_i}{r_j} = \left(\frac{Q_iR_{sub,i}^*}{Q_jR_{sub,j}^*}\right)^\frac{1}{4}
\end{equation}
with $Q_i$ and $Q_j$ the respective flow of segments $i$ and $j$.

Instead of storing the absolute radius for each segment, we consider the ratio between parent and its children: $\beta^i_k = r_i / r_k$ and $\beta^j_k = r_j / r_k$ with i and j the children, k the parent segment. Since the tree respects Murray's law, these ratios can actually be calculated directly from the ratio between children segments (see appendix for details):
\begin{equation}
\beta^i_k = \left( 1 + (\frac{r_i}{r_j})^{-\gamma}\right)^{-\frac{1}{\gamma}} \text{ and }
\beta^j_k = \left( 1 + (\frac{r_i}{r_j})^{\gamma}\right)^{-\frac{1}{\gamma}}
\end{equation}


Calculating the reduced resistance for each children with \eqref{red resistance}, and knowing the flow, we obtain the children radius ratio from \eqref{children ratio}, which is used to calculate the $\beta$ values, stored with the parent segment properties. 
The subtrees distal to the new bifurcation remain constant and unaffected by the addition of the new branch, whereas upstream bifurcations are updated following this exact same process. By this method, called "balancing of bifurcation ratios", radius rescaling is propagated up the tree.
 


\subsubsection{Measure target function}
Calculate the root radius from
\begin{equation}
r_{root} = \left( R_{sub, root}^* \frac{Q_{perf}}{P_{perf}-P_{term}}\right)^\frac{1}{4}
\end{equation}
Then for each segment we obtain the radius from:
\begin{equation}
r_i = r_{root} \prod\limits_{k=i}^{root} \beta_k
\end{equation}

So we can calculate the total tree volume. This is the target function that we seek to minimize:
\begin{equation}
T_i = l_i^{\mu} r_i^{\lambda}
\end{equation}

 

\subsubsection{Select best connection between neighbors}
We store the target function result in the Connection Evaluation Table (CET), for each of the tested neighbor connection. The connection yelding the lowest total tree volume is considered as the optimal one and definitely added to the tree, with the consequent flow and resistance updates.

If the CET does not contain at least two plausible connections among the $N_{con}$ tested, then we extend the search to the $N_{max}$ neighbor segments. If at least two plausible connection still do not come out of this process, we reject the tested location $n_{loc}$ and start again the main loop to add a new segment with a new random location.
By plausible connection we mean the local optimization converges, with no degenerate segment and no crossing of any other tree segment. 


\subsection{Example of results}
This section shows some of the output results. For better visualization the radius size has been increased by a factor $factor_r$ adapted to each situation.
\subsubsection{2D}
\begin{figure}[!h]
\centering
\subfigure{\includegraphics[width=0.45\textwidth]{./Images/CCOResults/tree_Nt250_f5_s42_paral.png}}
\subfigure{\includegraphics[width=0.45\textwidth]{./Images/CCOResults/tree_4000Nterm_factor5.png}}
\caption{Output of CCO in 2D with different $N_{Term}$, visualization with $ factor_r = 5 $. (left) A 250 Nterm tree generated in \unit{9}{min}. Note:The terminal pressure is adapted to the number of terminal segments, $P_{term}$=\unit{63}{\milli\meter}Hg. (right) A 4000 Nterm tree generated in 44 hours.}

\label{fig:CCO 2D}
\end{figure}

\subsubsection{3D}
\begin{figure}[!h]
\centering
\subfigure{\includegraphics[width=0.6\textwidth]{./Images/CCOResults/3Dtree_250Ntermfactor20.png}}
\caption{CCO in 3D: 250 Nterm tree generated in \unit{9.5}{min}. Visualization with $ factor_r = 20 $}
\label{fig:CCO 2D}
\end{figure}
%Output: images
%Can observe decrease of radius, to maintain constant resistance


%------------------------------------------------

\section{Local optimization: single bifurcation scale}\label{Kamiya}
Kamiya proposes a numerical solution to determine minimum volume bifurcation under restriction of physiological parameters, determinant pressure and flow, and locations of origin and terminals.

This method built in 2D assumes the flow to be laminar and vessels are composed of straight ducts lying on a plane. 

Note: Karch found that the optimum positions of the bifurcations in their 3D model trees were always found to lie in the plane defined by the endpoints of the respective three neighboring segments, which is consistent with the literature \cite{zamir1986branching}. 


\subsection*{Process: iterative nested loops}

Defining a starting position as the convex average of origin and terminal locations, weighted by respective flows.
\begin{equation}
(x,y) = (\frac{f_0x_0 + f_1x_1 + f_2x_2}{2f_0},\frac{f_0y_0 + f_1y_1 + f_2y_2 )}{2f_0})
\end{equation}
Calculate each segment length.
\begin{equation}
l_i^2 = (x - x_i)^2 + (y - y_i)^2
\label{length}
\end{equation}
Numerically calculate the new radii $r_0$, $r_1$,$r_2$. They are expected to satisfy both Hagen-Poiseuille's law and volume minimization.

When location of origin and two terminals segments, their pressure, and their flows are given, according to Hagen - Poiseuille's law:
\begin{align}
&\Delta P_1 = P_1 - P_0 = \kappa(\frac{f_0l_0}{r_0^4} + \frac{f_1l_1}{r_1^4}), \\
&\Delta P_2 = P_2 - P_0 = \kappa(\frac{f_0l_0}{r_0^4} + \frac{f_2l_2}{r_2^4})
\label{poiseuille}
\end{align}
  
According to  Kamiya, differentiating the tree volume with $x$, $y$ and $r_0$ and equating them to zero, one obtains:
\begin{equation}
\frac{r_0^6}{f_0} = \frac{r_1^6}{f_1} + \frac{r_2^6}{f_2}
\label{min volume}
\end{equation}
and 
\begin{equation}
x = \frac{x_0 r_0^2/l_0 + x_1 r_1^2/l_1 + x_2 r_2^2/l_2}{r_0^2/l_0 + r_1^2/l_1 + r_2^2 / l_2},
y = \frac{y_0 r_0^2/l_0 + y_1 r_1^2/l_1 + y_2 r_2^2/l_2}{r_0^2/l_0 + r_1^2/l_1 + r_2^2 / l_2}
\label{position}
\end{equation}
The details of the path to these equations is provided in appendix.

Using $R = r^2$ in \eqref{min volume}, we can express $R_0$ as:
\begin{equation}
R_0^3 = f_0(\frac{R_1^3}{f_1} + \frac{R_2^3}{f_2})
\end{equation} 
Substituting this inside \eqref{poiseuille}, one obtains the non linear system:
\begin{align}
\begin{cases}
&\frac{\Delta P_1}{\kappa}R_1^2 \left(f_0(\frac{R_1^3}{f_1} + \frac{R_2^3}{f_2}) \right)^\frac{2}{3} -f_0l_0R_1^2 - f_1l_1\left(f_0(\frac{R_1^3}{f_1} + \frac{R_2^3}{f_2}) \right)^\frac{2}{3} = 0 \\
&\frac{\Delta P_2}{\kappa}R_2^2 \left(f_0(\frac{R_1^3}{f_1} + \frac{R_2^3}{f_2}) \right)^\frac{2}{3} -f_0l_0R_2^2 - f_2l_2\left(f_0(\frac{R_1^3}{f_1} + \frac{R_2^3}{f_2}) \right)^\frac{2}{3} = 0
\end{cases}
\label{non linear system}
\end{align}

We are looking for the root satisfying these equations using a non linear solver. If the solution converges, we get the new radii, that are needed to calculate the new position of the branching point in \eqref{position}. This locations is a new input for the loop to iterate again (calculating length \eqref{length}, then new radii \eqref{non linear system}, new location \eqref{position} and so on). 
If this iterative loop converges and the bifurcation total volume decreases, the bifurcation is solved and provided with optimal radii and position.

Note: in CCO the pressure is not determined all along vessels (only at the root and terminal segments). In order to adapt to our situation, we use an estimated radius to calculate the pressure drops using \eqref{poiseuille}. At the first iteration the estimated radii are all equal to the segment's radius on which is connected the branch: $r_0 = r_1 = r_2 = r_{ori}$.
%At the first iteration the estimated radii correspond to the original segment radius (the one on which is added the connection): $r_0 = r_1 = r_{ori}$, and the radius of the last added segment to the tree (during the global growth): $r_2 = r_{n-1}$. 
Then, we will use the previously calculated radii to update the pressure drops at each iteration.

\subsection*{Example of results}
We give example of results on different type of bifurcations. For these example we used a tolerance of 0.01 and maximum number of iteration of 100.\\

\begin{figure}[!h]
\centering
\subfigure[$Q_l = Q_r = \frac{1}{2} Q_p$]{\includegraphics[width=0.45\textwidth]{./Images/Kamiya/Superposition_Firstandlast_t0.png}}
\subfigure[Random child locations and $Q_l = Q_r = \frac{1}{2} Q_p$]{\includegraphics[width=0.45\textwidth]{./Images/Kamiya/Superposition_Firstandlast_t1.png} }\\
\subfigure[$Q_l = \frac{1}{4} Q_p$ and $Q_l = \frac{3}{4} Q_p$]{\includegraphics[width=0.45\textwidth]{./Images/Kamiya/Superposition_Firstandlast_t2.png} }
\subfigure[Random child locations and $Q_l = \frac{1}{4} Q_p$, $Q_l = \frac{3}{4} Q_p$]{\includegraphics[width=0.45\textwidth]{./Images/Kamiya/Superposition_Firstandlast_t3.png} }

\caption{In blue the starting bifurcation (convex average position), in red the final bifurcation after Kamiya's algorithm convergence reached (tolerance = 0.01). Convergence was reached at 15th, 24th, 31st and 21st iteration respectively in (a),(b),(c),(d). $Q_p$ is the flow in parent branch, $Q_l$ and $Q_r$ are flows in left and right children.}
\label{fig:generation}
\end{figure}

In the figure \ref{fig:generation} (a), for symetric flows and child locations: the optimal bifurcation point corresponds to the convex average.

The figure \ref{fig:generation} (b) illustrates well a Steiner solution to optimal network \cite{bernot2009optimal}: it is more advantageous to transport flows together by delaying bifurcation. In the fluid mechanics context, this subadditivity follows from Poiseuille's law, according to which the resistance of a tube increases when it gets thinner.

The figure \ref{fig:generation} (c) shows influence of blood demand on the bifurcation geometry: because flow is more important on the right child, the radius is bigger and the bifurcation is dragged toward this child. Also, we note the bifurcation is less delayed than for symmetrical flows.

The figure \ref{fig:generation} (d) shows the influence of both destination and demand.


\subsection*{Karch implementation}

Karch added lower and upper bounds to Kamiya's algorithm that ensures:
(1) the bifurcation position within the perfusion volume; (2)
the non degeneracy of the bifurcation to zero (by constraining segment length over segment diameter).


%------------------------------------------------

\section*{Conclusion}

We implemented this CCO method with the same $N_{con}$ and $N_{max}$ as Karch (respectively 20 and 40). The 2D procedure is a good start for debugging, visalizing the results and easily convertible into 3D CCO.


When comparing results we wonder why they increase radii on the image with such a high factor. It might be due to their visualization tool resolution. We are still investing some non plausible branches happening on the 4000 $N_{term}$ tree.
\begin{figure}[!h]
\centering
\subfigure{\includegraphics[width=0.45\textwidth]{./Images/CCOResults/KarchResult.png}}
\caption{Karch's result with 4000 $N_{term}$ \cite{schreiner1993computer}}
\end{figure}

We improved computation time by parallelizing the connection test of neighbor segments.

The code is available for 2D and 3D on git hub repo: \verb|ClaraJaquet/HeartFlow/SyntheticTreeGeneration_Code|.



\begin{appendix}
\section*{Equation \eqref{min volume}, from Kamiya \& Togawa 1972 equation  (6)}
Kamiya uses Murray definition at equation (7) from Physiological principle of minimum work \cite{murray1926physiological} that he calls the simplest requirement for efficiency in the circulation:
\begin{equation*}
f = k r^3
\end{equation*}
With k being a constant, so that the flow of blood past any section shall everywhere bear the same relation to the cube of the radius of the vessel at that point. Using it as:
\begin{equation*}
r_i^3 = \frac{r_i^6 k}{f_i}
\end{equation*}

and combining it this with Murray's law,

\begin{equation*}
r_0^\gamma = r_1^\gamma + r_2^\gamma \text{ with } \gamma = 3
\end{equation*}

 where $r_0$ is the parent radius, $r_1$ and $r_2$ are the children radii, one obtains:
\begin{equation*}
\frac{k r_0^6}{f_0} = \frac{k r_1^6}{f_1} + \frac{k r_2^6}{f_2}
\end{equation*}
that can be simplified into equation \eqref{min volume}.


\section*{Equation \eqref{position}, from Kamiya \& Togawa 1972 equation  (7) }
We have
\begin{equation*}
\label{eq:V}
V = \pi(r_0^2 l_0 + r_1^2 l_1 + r_2^2 l_2)
\end{equation*}

and
\begin{align*}
l_0^2 &= \sqlen{0} \\
l_1^2 &= \sqlen{1} \\
l_2^2 &= \sqlen{2} 
\end{align*}

We rewrite \eqref{eq:V}

\begin{equation*}
V = \pi(r_0^2 \sqrt{\sqlen{0}} + r_1^2 \sqrt{\sqlen{1}} + r_2^2 \sqrt{\sqlen{2}})
\end{equation*}

We derive each term with respect to $x$.

\begin{equation*}
\frac{\partial}{\partial x} \sqrt{\sqlen{0}} = \frac{x-x_0}{\sqrt{\sqlen{0}}} = \frac{x-x_0}{l_0},
\end{equation*}
same for the $x_1$ and $x_2$ term, so we have

\begin{equation*}
\frac{\partial V}{\partial x} = \pi\left[ \frac{r_0^2(x-x_0)}{l_0} + \frac{r_1^2(x-x_1)}{l_1} + \frac{r_2^2(x-x_2)}{l_2}\right] = 0
\end{equation*}

Discarding the $\pi$ factor and separating the terms,

\begin{align*}
x\rili{0} + x\rili{1} + x\rili{2} &= x_0\rili{0} + x_1\rili{1} + x_2\rili{2} \\
x(\rili{0} + \rili{1} + \rili{2}) &= x_0\rili{0} + x_1\rili{1} + x_2\rili{2} 
\end{align*}

and so

\begin{equation*}
x = \frac{x_0\rili{0} + x_1\rili{1} + x_2\rili{2}}{\rili{0} + \rili{1} + \rili{2}}
\end{equation*}

This is one half of Eq.(7) in Kamiya \& Togawa. The other half is obtained by substituting $x$ with $y$ everywhere. This is
formally correct but not 100\% satisfying since the $l_i$ depend on $x$ and $y$.

\end{appendix}

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

\bibliographystyle{unsrt}

\bibliography{sample}

%----------------------------------------------------------------------------------------

\end{document}